__Требования к системе рекомендаций Маркетплейса__

__Обзор системы__

Комбинированный подход предоставления ПО Paas и Iaas, для сервиса рекомендаций в рамках микросервисной архитектуры. 
Основные вызовы, которые решает система:
1. Омниканальность
2. Доступность 24х7
3. Персонализация
4. Безопасность и отказоустойчивость
5. Масштабируемость (горизонтальная, вертикальная)

__Назначение системы__
Персонализированная рекомендательная система призвана повысить вовлеченность пользователей и конверсию, путем предоставления рекомендаций в зависимости от предпочтений пользователей в разных точках маркетплейса (главная страница, карточки товаров, корзина, акции)

__Основные пользователи__: гости, пользователи системы и продавцы.
Косвенные: бизнес-пользователи, команда обслуживания системы.

__Границы системы__

__Включает:__ сбор данных о пользовательских действиях (транзакции (покупки, возвраты), клики, продолжительность контакта, переходы между функциональными единицами (отзывы, акции, рекомендации), отложенные товары и т.д.), генерацию фичей, обучение моделей на исторических данных, выдачу рекомендаций, хранение фичей и моделей, передачу данных на аналитику.

__Не включает:__ UI/UX дизайн, систему управления заказами, товарами, пользователями, аналитику.

__Требования к рекомендательной системе персонализированных рекомендаций:__

__1. Функциональные требования к системе:__

__1.1. Требования к функциям для “гостей”:__

1.1.1. Система должна при первичном посещение маркетплейса выводить данные, основываясь на общей популярности товаров по категориям, трендам и базовой информации о сессии пользователей (город и регион, тип устройства).

1.1.2. Система должна использовать сессионные данные гостя (просмотр товаров, добавление в корзину, время удержания) для генерации рекомендаций в режиме реального времени.

1.1.3. Система должна использовать заранее подготовленные модели, для формирования пользовательских предпочтений гостя.

1.1.4. Система должна сохранять сгенерированные пользовательские предпочтения, для дальнейшего их использования.

__1.2. Требования к функциям для аутентифицированных “пользователей”:__
__Раздел рекомендаций “Для тебя”_

1.2.1. Для новых пользователей без истории рекомендаций или сессий, должны формироваться рекомендации исходя из сессионных данных (город и регион, тип устройства) и выбранных им при регистрации “интересных” товарах.

1.2.2. Система должна генерировать персонализированные рекомендации для каждого уникального пользователя на основе предыдущих сессий: просмотры, клики, лайки, корзина, покупки, реакции на комментарии.

1.2.3. Система должна адаптироваться и учитывать изменения в рамках одной сессии для уникального пользователя, генерируя новые рекомендации на основе общего портрета пользователя и данных сессии.

1.2.4. Система должна учитывать пожелания пользователей не показывать ему те или иные товары и/или группы товаров.
Раздел рекомендаций “ Похожие товары”:

1.2.4. Система должна учитывать в рекомендации похожих товаров персонализированный пользовательский портрет.

1.2.5. Система должна учитывать в рекомендациях похожих товаров поведение других пользователей, с похожим пользовательским портретом.


__1.3. Требования к функциям для “продавцов” маркетплейса:__

1.3.1. Система рекомендаций должна включать в новые товары (с базовым описанием и категориями) в рекомендательные списки в соответствие с заданными алгоритмами, для накопления истории взаимодействий.

1.3.2. Система должна предоставлять информацию по тому, как их товары рекомендуются пользователям (количество показов, конверсию по рекомендациям).

__1.4. Требования к функциям для “бизнес-пользователей”:__

1.4.1. Система должна предоставлять агрегированные данные об эффективности рекомендаций по различным критериям для глубокого анализа.

1.4.2. Система должна предоставлять возможность сравнивать эффективность различных версий рекомендаций моделей и А/В-тестов по ключевым метрикам.

__1.5. Требования к функциям для “операционной команды”:__

1.5.1. Система должна предоставлять метрики (в частности производительности, потребления ресурсов, пути запросов) и статусы доступности для всех своих компонентов (API-сервис, движки фичей, кэши, хранилища и т.д.) в режиме реального времени.

1.5.2. Система должна предоставлять стандартизированные и автоматизированные способы управления всеми компонентами.

1.5.3. Система должны поддерживать горизонтальное и вертикальное масштабирование компонентов системы для обработки изменяющейся нагрузки.



__2. Нефункциональные требования__

__2.1. Требования к производительности:__

_2.1.1. Запросы в секунду для_

2.1.1.1. Штатный режим:

-API сервис рекомендаций: 5,000-10,000 RPS (request per second)

-Сборщик активностей: 50,000-100,000 EPS (event per second)

2.1.1.2. Пиковые нагрузки:

-API сервис рекомендаций: 25,000-50,000 RPS

-Сборщик активностей: 200,000-500,000 EPS

_2.1.2. Допустимое время ответа:_

2.1.2.1. Штатный режим: 98-й перцентиль от времени обработки - 100 мс для API сервиса рекомендаций.

2.1.2.2. Пиковая нагрузка: 98-й перцентиль от времени обработки - 150 мс для API сервиса рекомендаций.

2.1.2.3. Сквозная задержка обработки - не позднее 5 секунд после пользовательского события.

_2.1.3. DAU (ежедневные активные пользователи):_

- на старте: 1,000,000-1,500,000 DAU;

- через год: 3,000,000-5,000,000 DAU;

- через 2 года: 5,000,000-8,000,000 DAU/

_2.1.4. Общее число зарегистрированных пользователей:_

- на старте: 10,000,000-15,000,000;

- через год: 30,000,000-50,000,000;

- через 2 года: 50,000,000-100,000,000.

_2.1.5. Конкурирующие пользователи в день_

- в обычном режиме: 100,000-200,000;

- пиковая нагрузка: 500,000-1,000,000.

_2.1.6. Хранимые данные:_

2.1.6.1. Ожидаемое число объектов разного типа:

- сырые события: 100-300 миллионов событий в день( пик 1 миллиард);

- позиций в каталоге: 50 миллионов уников;

- фичи пользователей: MAU*уникальных фичей. Средний вес 100 кв.

2.1.6.2. Типы хранимых данных:

- структурированные и полуструктурированные данные о событиях фичах, метаданных, логах (до 5 КВ).

- бинарные файлы моделей до 100 ГБ штука (от 100 МБ).

2.1.6.3. Явных ограничений по количеству данных нет.

2.1.6.4. Срок хранения данных:

- сырые данные в Kafka: 7 дней.

- сырые события в Data Lake: 7 лет.

- исторические фичи: 5 лет.

- сгенерированные кандидаты: 3 года.

- эмбеддинг товаров: 3 года.

- кэш time to life: 24 часа.

- обученные модели: бессрочно.

2.1.7. Ограничение по мощности: физических ограничений нет, так как система использует Paas/IaaS с возможностью автомасштабирования.

2.1.8. Время восстановления после отказов:

2.1.8.1. Целевое время восстановление сервисов:

- API рекомендаций: меньше 2 минут.

- Оркестратор: меньше 2 минут.

- Кэш: меньше 3 минут.

- Потоковая обработка: меньше 15 минут.

- Пакетные и потоковые процессы: менее 2 часов.

2.1.8.2. Целевое время восстановления данных (допустимая потеря):

- API, оркестрация, кэш: 0.

- Потоковая и пакетная обработка: менее 1 часа.

2.1.9. Допустимое время простоя при плановых работах за год:

- API, оркестрация, кэш: 99,999 - 5 минут.

- Пакетные и потоковые процессы: 99,99 - 53 минуты в год.

__2.2. Требования к безопасности системы__

2.2.1. Защита от несанкционированного доступа:

- внешние: попытки доступа к публичному API без авторизации или некорректными данными.

- несанкционированный доступ сотрудников.

2.2.2. Утечка данных:

- персональные данные пользователей.

- чувствительные бизнес-данные.

2.2.3. Вредоносные атаки:

- DDos-атаки.

- атаки внедрения (хотя система не типичная веб).

- атаки на цепочку поставок (CI/CD).

- атаки на ML-модели.

2.2.4. Роли пользователей системы рекомендаций:

- Системные пользователи площадки: вызов API (только чтение) и сборщик активности (только запись событий)

- ML-инженер / инженер данных: Хранилище аналитических данных (чтение), Платформа обучения ML (чтение, создание, обновление), регистр моделей (чтение, запись).

- Продуктовый аналитик /бизнес-пользователь: Хранилище аналитических данных (чтение).

- Операционная команда: имеет право на чтение логов, управление развертыванием, доступ к серверной инфраструктуре.

- Администратор: имеет полные права, включая управление доступом.

2.2.5. Схема авторизации и аутентификации:

2.2.5.1. Для конечных пользователей системы (Keycloak):

- аутентификация OpenID Connector (OIDC) + JWT-токен.

- авторизация OAuth 2.0 по JWT-токену.

2.2.5.2. Для внутренних пользователей системы (HashiCorp Vault):

- через OpenID Connector (OIDC) + JWT-токен.

- авторизация OAuth 2.0 по роли и атрибутам.

2.2.6. Шифрование межсервисного трафика:

- HTTPS: внешние и внутренние API вызовы.

- TLS/SSL: все соединения с базами данных, кэш, реестром и брокером сообщений.

2.2.7. Обращение с персональными данными.

- сервис обрабатывает анонимизированные данные о поведение пользователей и напрямую не хранит идентифицированные персональные данные (имя, телефон, данные карты и т.д.). 

- хранение осуществляется в централизованном Data Lace и операционных базах данных компонентов системы.

- данные хранятся на облачных сервисах на территории России.

2.2.8. Резервное копирование:

- регулярное резервное копирование критических данных осуществляется на облачный сервис каждые 24 часа.

- озеро данных копируется каждые 7 дней.

- для кэша предусмотрены точки сохранения каждый 1 час.

- шина событий использует чекпоинты.

__3.Требования к совместимости__

3.1. Данный сервис является бэкэнд-сервисом, поэтому не имеет отдельного пользовательского интерфейса. Вызову к сервису осуществляется по запросу от фронтовой части Маркетплейса.

3.2. Система предназначена для работы в контейнерах (Docker/Kubernetes), которая разворачивается на операционной системе Linux.

3.3. Интеграции разрабатываемой системы:

- с основной оркестрацией платформы Маркетплейса: HTTPS/TLS для API вызовов с форматом JSON.

- с шиной событий Маркетплейса: поддержка TLS и протокол Kafka по сертификату SSL.

- Data Lace: совместимость с S3 API.

- DWH: через debezium.

- Хранилище аналитических данных: по стандартам SQL (JDBC).

- Кэш: совместимость протокола Redis и поддержка TLS.

- Регистр моделей: совместимость с MLflow.

- Системы мониторинга: совместимость со стандартными протоколами (Prometheus. Grafana).

